(function($){$.fn.formset=function(opts){var options=$.extend({},$.fn.formset.defaults,opts);var $this=$(this);var $parent=$this.parent();var nextIndex=get_no_forms(options.prefix);var group=$this.closest(".inline-group");group.data("django_formset",options);$this.each(function(i){$(this).not("."+options.emptyCssClass).addClass(options.formCssClass)});if(isAddButtonVisible(options)){var addButton;if($this.attr("tagName")=="TR"){var numCols=this.eq(-1).children().length;$parent.append('<tr class="'+options.addCssClass+'"><td colspan="'+numCols+'"><a href="javascript:void(0)">'+options.addText+"</a></tr>");addButton=$parent.find("tr:last a")}else{$this.filter(":last").after('<div class="'+options.addCssClass+'"><a href="javascript:void(0)">'+options.addText+"</a></div>");addButton=$this.filter(":last").next().find("a")}addButton.click(function(e){e.preventDefault();addRow(options)})}return this};$.fn.formset.defaults={prefix:"form",addText:"add another",deleteText:"remove",addCssClass:"add-row",deleteCssClass:"delete-row",emptyCssClass:"empty-row",formCssClass:"dynamic-form",added:null,removed:null};$.fn.tabularFormset=function(options){var $rows=$(this);var alternatingRows=function(row){row_number=0;$($rows.selector).not(".add-row").removeClass("row1 row2").each(function(){$(this).addClass("row"+(row_number%2+1));next=$(this).next();while(next.hasClass("nested-inline-row")){next.addClass("row"+(row_number%2+1));next=next.next()}row_number=row_number+1})};var reinitDateTimeShortCuts=function(){if(typeof DateTimeShortcuts!="undefined"){$(".datetimeshortcuts").remove();DateTimeShortcuts.init()}};var updateSelectFilter=function(){if(typeof SelectFilter!="undefined"){$(".selectfilter").each(function(index,value){var namearr=value.name.split("-");SelectFilter.init(value.id,namearr[namearr.length-1],false,options.adminStaticPrefix)});$(".selectfilterstacked").each(function(index,value){var namearr=value.name.split("-");SelectFilter.init(value.id,namearr[namearr.length-1],true,options.adminStaticPrefix)})}};var initPrepopulatedFields=function(row){row.find(".prepopulated_field").each(function(){var field=$(this),input=field.find("input, select, textarea"),dependency_list=input.data("dependency_list")||[],dependencies=[];$.each(dependency_list,function(i,field_name){dependencies.push("#"+row.find(".field-"+field_name).find("input, select, textarea").attr("id"))});if(dependencies.length){input.prepopulate(dependencies,input.attr("maxlength"))}})};$rows.formset({prefix:options.prefix,addText:options.addText,formCssClass:"dynamic-"+options.prefix,deleteCssClass:"inline-deletelink",deleteText:options.deleteText,emptyCssClass:"empty-form",removed:function(row){alternatingRows(row);if(options.removed)options.removed(row)},added:function(row){initPrepopulatedFields(row);reinitDateTimeShortCuts();updateSelectFilter();alternatingRows(row);if(options.added)options.added(row)}});return $rows};$.fn.stackedFormset=function(options){var $rows=$(this);var update_inline_labels=function(formset_to_update){formset_to_update.children(".inline-related").not(".empty-form").children("h3").find(".inline_label").each(function(i){var count=i+1;$(this).html($(this).html().replace(/(#\d+)/g,"#"+count))})};var reinitDateTimeShortCuts=function(){if(typeof DateTimeShortcuts!="undefined"){$(".datetimeshortcuts").remove();DateTimeShortcuts.init()}};var updateSelectFilter=function(){if(typeof SelectFilter!="undefined"){$(".selectfilter").each(function(index,value){var namearr=value.name.split("-");SelectFilter.init(value.id,namearr[namearr.length-1],false,options.adminStaticPrefix)});$(".selectfilterstacked").each(function(index,value){var namearr=value.name.split("-");SelectFilter.init(value.id,namearr[namearr.length-1],true,options.adminStaticPrefix)})}};var initPrepopulatedFields=function(row){row.find(".prepopulated_field").each(function(){var field=$(this),input=field.find("input, select, textarea"),dependency_list=input.data("dependency_list")||[],dependencies=[];$.each(dependency_list,function(i,field_name){dependencies.push("#"+row.find(".form-row .field-"+field_name).find("input, select, textarea").attr("id"))});if(dependencies.length){input.prepopulate(dependencies,input.attr("maxlength"))}})};$rows.formset({prefix:options.prefix,addText:options.addText,formCssClass:"dynamic-"+options.prefix,deleteCssClass:"inline-deletelink",deleteText:options.deleteText,emptyCssClass:"empty-form",removed:function(row){update_inline_labels(row);if(options.removed)options.removed(row)},added:function(row){initPrepopulatedFields(row);reinitDateTimeShortCuts();updateSelectFilter();update_inline_labels(row.parent());if(options.added)options.added(row)}});return $rows};function create_nested_formsets(parentPrefix,rowId){var sourceParentPrefix=parentPrefix.replace(/[-][0-9]*[-]/g,"-0-");var row_prefix=parentPrefix+"-"+rowId;var row=$("#"+row_prefix);var search_space=$("#"+sourceParentPrefix+"-0");var nested_inlines=search_space.find("."+sourceParentPrefix+"-nested-inline");nested_inlines.each(function(index){var normalized_formset_prefix=$(this).attr("id").split("-group")[0];var formset_prefix=normalized_formset_prefix.replace(sourceParentPrefix+"-0",row_prefix);var template=$(this).clone();var options=$(this).data("django_formset");options=$.extend({},options);options.prefix=formset_prefix;var isTabular=template.find("#"+normalized_formset_prefix+"-empty").is("tr");if(isTabular){template.find(".form-row").not(".empty-form").remove();template.find(".nested-inline-row").remove()}else{template.find(".inline-related").not(".empty-form").remove()}template.find("."+options.addCssClass).remove();update_props(template,normalized_formset_prefix,formset_prefix);template.find("#id_"+formset_prefix+"-INITIAL_FORMS").val(0);template.find("#id_"+formset_prefix+"-TOTAL_FORMS").val(0);template.find(".original").empty();var formset;if(isTabular){formset=template.find(".tabular.inline-related tbody tr."+formset_prefix+"-not-nested").tabularFormset(options);var border_class=index+1<nested_inlines.length?" no-bottom-border":"";var wrapped=$('<tr class="nested-inline-row'+border_class+'"/>').html($('<td colspan="100%"/>').html(template));row.after(wrapped)}else{formset=template.find(".inline-related").stackedFormset(options);row.after(template)}var $parentPk=$("#id_"+parentPrefix+"-"+rowId+"-id").val();if(!$parentPk){var $myId=template.find("input[name$=-id]").first();var $myFk=$myId.next();$myFk.val(null)}addRow(options)});return nested_inlines.length}function update_props(template,normalized_formset_prefix,formset_prefix){template.attr("id",template.attr("id").replace(normalized_formset_prefix,formset_prefix));template.find("*").each(function(){if($(this).attr("for")){$(this).attr("for",$(this).attr("for").replace(normalized_formset_prefix,formset_prefix))}if($(this).attr("class")){$(this).attr("class",$(this).attr("class").replace(normalized_formset_prefix,formset_prefix))}if(this.id){this.id=this.id.replace(normalized_formset_prefix,formset_prefix)}if(this.name){this.name=this.name.replace(normalized_formset_prefix,formset_prefix)}})}function get_no_forms(formset_prefix){var formset_prop=$("#id_"+formset_prefix+"-TOTAL_FORMS");if(!formset_prop.length){return 0}return parseInt(formset_prop.attr("autocomplete","off").val(),10)}function change_no_forms(formset_prefix,increase){var no_forms=get_no_forms(formset_prefix);if(increase){$("#id_"+formset_prefix+"-TOTAL_FORMS").attr("autocomplete","off").val(parseInt(no_forms)+1)}else{$("#id_"+formset_prefix+"-TOTAL_FORMS").attr("autocomplete","off").val(parseInt(no_forms)-1)}}function get_max_forms(formset_prefix){var max_forms=$("#id_"+formset_prefix+"-MAX_NUM_FORMS").attr("autocomplete","off").val();if(typeof max_forms=="undefined"||max_forms==""){return""}return parseInt(max_forms)}function addRow(options){var nextIndex=get_no_forms(options.prefix);var row=insertNewRow(options.prefix,options);updateAddButton(options.prefix);row.find("a."+options.deleteCssClass).click(function(e){e.preventDefault();var row=$(this).parents("."+options.formCssClass);var formset_to_update=row.parent();while(row.next().hasClass("nested-inline-row")){row.next().remove()}row.remove();change_no_forms(options.prefix,false);if(options.removed){options.removed(formset_to_update)}});var num_formsets=create_nested_formsets(options.prefix,nextIndex);if(row.is("tr")&&num_formsets>0){row.addClass("no-bottom-border")}if(options.added){options.added(row)}nextIndex=nextIndex+1}function insertNewRow(prefix,options){var template=$("#"+prefix+"-empty");var nextIndex=get_no_forms(prefix);var row=prepareRowTemplate(template,prefix,nextIndex,options);row.insertBefore($(template));change_no_forms(prefix,true);return row}function prepareRowTemplate(template,prefix,index,options){var row=template.clone(true);row.removeClass(options.emptyCssClass).addClass(options.formCssClass).attr("id",prefix+"-"+index);if(row.is("tr")){row.children(":last").append('<div><a class="'+options.deleteCssClass+'" href="javascript:void(0)">'+options.deleteText+"</a></div>")}else if(row.is("ul")||row.is("ol")){row.append('<li><a class="'+options.deleteCssClass+'" href="javascript:void(0)">'+options.deleteText+"</a></li>")}else{row.children(":first").append('<span><a class="'+options.deleteCssClass+'" href="javascript:void(0)">'+options.deleteText+"</a></span>")}row.find("*").each(function(){updateElementIndex(this,prefix,index)});return row}function updateElementIndex(el,prefix,ndx){var id_regex=new RegExp("("+prefix+"-(\\d+|__prefix__))");var replacement=prefix+"-"+ndx;if($(el).attr("for")){$(el).attr("for",$(el).attr("for").replace(id_regex,replacement))}if(el.id){el.id=el.id.replace(id_regex,replacement)}if(el.name){el.name=el.name.replace(id_regex,replacement)}}function updateAddButton(options){var btn=$("#"+options.prefix+"-empty").parent().children("."+options.addCssClass);if(isAddButtonVisible(options)){btn.show()}else{btn.hide()}}function isAddButtonVisible(options){return!(get_max_forms(options.prefix)!==""&&get_max_forms(options.prefix)-get_no_forms(options.prefix)<=0)}})(django.jQuery);
